# RSR-Certified Docker/Podman Compose Configuration
#
# Usage:
#   docker compose up -d
#   podman-compose up -d

name: rsr-certified

services:
  # Main RSR compliance engine and webhook server
  rsr-engine:
    build:
      context: ..
      dockerfile: container/Containerfile
    image: ghcr.io/hyperpolymath/rsr-certified:latest
    container_name: rsr-engine
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - RSR_LOG_LEVEL=${RSR_LOG_LEVEL:-info}
      - RSR_PLATFORMS=${RSR_PLATFORMS:-github,gitlab,bitbucket}
      - RSR_REDIS_URL=redis://redis:6379
      # Platform credentials (set via .env file)
      - GITHUB_APP_ID=${GITHUB_APP_ID:-}
      - GITHUB_PRIVATE_KEY=${GITHUB_PRIVATE_KEY:-}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET:-}
      - GITLAB_TOKEN=${GITLAB_TOKEN:-}
      - GITLAB_WEBHOOK_SECRET=${GITLAB_WEBHOOK_SECRET:-}
      - BITBUCKET_TOKEN=${BITBUCKET_TOKEN:-}
    volumes:
      - rsr-config:/etc/rsr:ro
      - rsr-cache:/var/cache/rsr
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - rsr-network

  # Background worker for async processing
  rsr-worker:
    build:
      context: ..
      dockerfile: container/Containerfile
    image: ghcr.io/hyperpolymath/rsr-certified:latest
    container_name: rsr-worker
    restart: unless-stopped
    command: ["rsr", "serve", "--worker-only"]
    environment:
      - RSR_LOG_LEVEL=${RSR_LOG_LEVEL:-info}
      - RSR_REDIS_URL=redis://redis:6379
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GITLAB_TOKEN=${GITLAB_TOKEN:-}
      - BITBUCKET_TOKEN=${BITBUCKET_TOKEN:-}
    volumes:
      - rsr-config:/etc/rsr:ro
      - rsr-cache:/var/cache/rsr
    depends_on:
      - redis
    networks:
      - rsr-network

  # Redis for job queue and caching
  redis:
    image: docker.io/redis:7-alpine
    container_name: rsr-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rsr-network

  # Optional: PostgreSQL for persistent storage
  # Uncomment if you need persistent compliance history
  # postgres:
  #   image: docker.io/postgres:16-alpine
  #   container_name: rsr-postgres
  #   restart: unless-stopped
  #   environment:
  #     - POSTGRES_USER=rsr
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
  #     - POSTGRES_DB=rsr
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U rsr"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - rsr-network

volumes:
  rsr-config:
    name: rsr-config
  rsr-cache:
    name: rsr-cache
  redis-data:
    name: rsr-redis-data
  # postgres-data:
  #   name: rsr-postgres-data

networks:
  rsr-network:
    name: rsr-network
    driver: bridge
